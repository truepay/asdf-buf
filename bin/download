#!/usr/bin/env bash

: "${ASDF_INSTALL_VERSION:?"Missing ASDF_INSTALL_VERSION"}"
: "${ASDF_DOWNLOAD_PATH:?"Missing ASDF_DOWNLOAD_PATH"}"

get_download_url() {
  local os arch

  os=$(uname -s)
  arch=$(uname -m)

  # Apple M1 architecture (arm64) doesn't have binaries, so we install the x86_64 version
  if [[ "${os}" == "Darwin" && "${arch}" == "arm64" ]]; then
    arch="x86_64"
  fi

  # shellcheck disable=SC2154
  echo "https://github.com/bufbuild/buf/releases/download/v${ASDF_INSTALL_VERSION}/buf-${os}-${arch}.tar.gz"
}

download() {
  curl -fsSL "$(get_download_url)" -o "${ASDF_DOWNLOAD_PATH}/buf.tar.gz" ||
    echo "Download failed!" 1>&2
}

download
